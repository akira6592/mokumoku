---
- hosts: tower01
  gather_facts: false
  connection: local

  environment:
    CONTROLLER_USERNAME: admin
    CONTROLLER_PASSWORD: "{{ tower_password }}"
    CONTROLLER_HOST: https://{{ ansible_host }}

  tasks:
    # ワークフロージョブテンプレートの作成
    - name: create workflow job template
      ansible.controller.workflow_job_template:
        name: Workshop Workflow
        inventory: Workshop Inventory
        organization: Default

    # ワークフロージョブテンプレートノードの作成
    # 未定義エラーを防ぐために、最後のノードから順に作成する
    - name: node301
      ansible.controller.workflow_job_template_node:
        identifier: node301
        workflow: Workshop Workflow
        unified_job_template: Network Automation - Restore

    - name: node201
      ansible.controller.workflow_job_template_node:
        identifier: node201
        workflow: Workshop Workflow
        unified_job_template: Network-Banner
        failure_nodes:
          - node301
    
    - name: node202
      ansible.controller.workflow_job_template_node:
        identifier: node202
        workflow: Workshop Workflow
        unified_job_template: Network-User
        failure_nodes:
          - node301

    - name: node101
      ansible.controller.workflow_job_template_node:
        identifier: node101
        workflow: Workshop Workflow
        unified_job_template: Backup network configurations
        success_nodes:
          - node201
          - node202
